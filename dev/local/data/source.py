#AUTOGENERATED! DO NOT EDIT! File to edit: dev/06_data_source.ipynb (unless otherwise specified).

__all__ = ['DataSource', 'DsrcSubset']

from ..imports import *
from ..test import *
from ..core import *
from .core import *
from .transform import *
from .pipeline import *
from ..notebook.showdoc import show_doc

class _FiltTfmdList(TfmdList):
    "Like `TfmdList` but with filters and train/valid attribute, for proper setup"
    def __init__(self, items, tfms, filts, filt_idx, do_setup=True, as_item=True):
        self.filts,self.filt_idx = filts,filt_idx
        super().__init__(items, tfms, do_setup=do_setup, as_item=as_item, filt=None)

    def _get(self, i):
        self.filt = self.filt_idx[i]
        return super()._get(i)

    def subset(self, i): return DsrcSubset(self, i)

_FiltTfmdList.train,_FiltTfmdList.valid = add_props(lambda i,x: x.subset(i), 2)

class DataSource(TfmdDS):
    "Applies a `tfm` to filtered subsets of `items`"
    def __init__(self, items, tfms=None, filts=None, do_setup=True):
        if filts is None: filts = [range_of(items)]
        self.filts = L(mask2idxs(filt) for filt in filts)
        # Create map from item id to filter id
        assert all_disjoint(self.filts)

        self.items = L(items)
        self.filt_idx = L([None]*len(self.items))
        for i,f in enumerate(self.filts): self.filt_idx[f] = i
        self.tls = [_FiltTfmdList(self.items, t, self.filts, self.filt_idx, do_setup=do_setup)
                    for t in L(tfms)]

    @property
    def n_subsets(self): return len(self.filts)
    def subset(self, i): return DsrcSubset(self, i)
    def subsets(self): return map(self.subset, range(self.n_subsets))
    def __repr__(self):
        return '\n'.join(map(str,self.subsets())) + f'\ntls - {self.tls}'

    def _get(self, i):
        self.filt = self.filt_idx[i]
        return super()._get(i)

    @delegates(TfmdDL.__init__)
    def databunch(self, bs=16, val_bs=None, shuffle_train=True, **kwargs):
        n = self.n_subsets-1
        bss = [bs] + [2*bs]*n if val_bs is None else [bs] + [val_bs]*n
        shuffles = [shuffle_train] + [False]*n
        dls = [TfmdDL(self.subset(i), bs=b, shuffle=s, drop_last=s, **kwargs)
               for i,(b,s) in enumerate(zip(bss, shuffles))]
        return DataBunch(*dls)

DataSource.train,DataSource.valid = add_props(lambda i,x: x.subset(i), 2)

class DsrcSubset(TfmdDS):
    "A filtered subset of a `DataSource`"
    def __init__(self, dsrc, filt):
        tfms = [o.tfms for o in dsrc.tls]
        super().__init__(dsrc.items[dsrc.filts[filt]], tfms=tfms, do_setup=False, filt=filt)

    def __repr__(self): return coll_repr(self)